---
import type { Props } from '@astrojs/starlight/props'
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro'
import { verifyToken } from '../lib/auth';
import { generateSidebar, convertToSidebarEntry  } from '../utils/sidebarUtils';
type StarlightPageFrontmatter = any;

console.log('pages/index.astro');

function odmianaRoli(userRole: string) {
  switch (userRole) {
    case 'admin':
      return 'admina';
    case 'klient':
      return 'klienta';
    case 'spółka':
      return 'spółkowicza';
    case 'realizator':
      return 'realizatora';
    default:
      return userRole; // Zwraca oryginalną wartość, jeśli nie pasuje do żadnego przypadku
  }
}


let user;
const token = Astro.cookies.get('token')?.value;
// Sprawdź token w ciasteczku, jeśli user nie jest ustawiony
if (token) {
  try {
    user = verifyToken(token);
  } catch (error) {
    console.error('pages/index.astro Invalid token:', error);
  }
}

// Dodaj sprawdzanie, czy user istnieje, zanim uzyskasz dostęp do jego właściwości
if (user) {
  console.log('pages/index.astro User ID:', user.id);
  console.log('pages/index.astro User username:', user.username);
  console.log('pages/index.astro User role:', user.role);
}

const userRole = user?.role || 'klient';
console.log('pages/index.astro Userrole:', userRole);
const dynamicSidebar = generateSidebar(userRole);
const starlightSidebar = convertToSidebarEntry(dynamicSidebar);

const odmiana = odmianaRoli(userRole);

const title = "Manual";
const description = "Get started building your docs site with Starlight.";
const tagline = `obsługi studia Flightcore dla ${odmiana}`;

const logoutButton = user ? {
  text: "Wyloguj",
  link: "#",
  icon: "right-arrow",
  variant: "primary",
  id: "logout-button",
  class: "logout-button astro-button",
  'data-logout': 'true',
  custom: true
} : {
  text: "Zaloguj",
  link: "/login",
  icon: "right-arrow",
  variant: "primary"
};

const frontmatter: StarlightPageFrontmatter = {
  title: title,
  description: description,
  template: 'splash',
  hero: {
    tagline: tagline,
    actions: [
      logoutButton as any, // Ostatecznie wymuszenie zgodności typów
      {
        text: "Przejdź do strony Flightcore Studios",
        link: "https://flightcore.pl",
        icon: "external"
      }
    ]
  },
  // Dodaj inne właściwości, które mogą być wymagane przez StarlightPageFrontmatter
};
---

<StarlightPage
  frontmatter={frontmatter}
  hasSidebar={true}
  sidebar={starlightSidebar}
  >
</StarlightPage>

<script>
  function handleLogout(event: { preventDefault: () => void; }) {
    event.preventDefault();
    console.log('pages/index.astro Logout function called');
    
    fetch('/api/auth/logout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      console.log('pages/index.astro Logout response status:', response.status);
      if (response.ok) {
        console.log('pages/index.astro Logout successful');
        localStorage.removeItem('token');
        document.cookie = 'token=; Max-Age=0; path=/; domain=' + location.hostname;
        window.location.href = '/';
      } else {
        console.error('pages/index.astro Logout failed');
      }
    })
    .catch(error => {
      console.error('pages/index.astro Error during logout:', error);
    });
  }

  function setupLogoutButton() {
    // Szukamy przycisku po tekście "Wyloguj"
    const buttons = Array.from(document.querySelectorAll('a, button'));
    const logoutButton = buttons.find(button => button.textContent?.trim() === 'Wyloguj');

    
    if (logoutButton) {
      console.log('pages/index.astro Logout button found:', logoutButton);
      logoutButton.addEventListener('click', handleLogout);
      
      // Dodajemy nasze własne atrybuty
      logoutButton.setAttribute('data-logout', 'true');
      logoutButton.id = 'logout-button';
      logoutButton.classList.add('logout-button', 'astro-button');
    } else {
      console.log('pages/index.astro Logout button not found');
    }
  }

  function attemptSetup() {
    setupLogoutButton();
    if (!document.querySelector('[data-logout]')) {
      console.log('pages/index.astro Retrying setup...');
      setTimeout(attemptSetup, 500);
    }
  }

  // Próbujemy ustawić przycisk po załadowaniu DOM
  document.addEventListener('DOMContentLoaded', attemptSetup);

  // Próbujemy ustawić przycisk po pełnym załadowaniu strony
  window.addEventListener('load', attemptSetup);

  // Nasłuchujemy na zdarzenie Astro
  document.addEventListener('astro:page-load', attemptSetup);

  // Sprawdzamy, czy użytkownik jest zalogowany po stronie klienta
  const token = localStorage.getItem('token');
  if (token) {
    fetch('/api/auth/me', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => response.json())
    .then(user => {
      const content = document.getElementById('content');
      if (content) {
        content.innerHTML = `
          <div>
            <h1>Cześć, ${user.ksywa || user.username}!</h1>
            <p>Wybierz interesujący Cię temat lub skorzystaj z wyszukiwarki.</p>
          </div>
        `;
      }
      attemptSetup();
    })
    .catch(error => {
      console.error('pages/index.astro Error fetching user data:', error);
      localStorage.removeItem('token');
    });
  }

  console.log('pages/index.astro Script loaded');
</script>

